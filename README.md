# API Каталога Товаров для Интерьера

Этот проект представляет собой FastAPI-приложение для управления каталогом товаров для интерьера. Он использует PostgreSQL в качестве базы данных и Docker для легкого развертывания, администрирования и обеспечения безопасности.

## Ключевые Технологии

- **FastAPI**: Современный, быстрый (высокопроизводительный) веб-фреймворк для создания API.
- **PostgreSQL**: Мощная, объектно-реляционная система управления базами данных.
- **Asyncpg**: Высокопроизводительный драйвер для работы с PostgreSQL в асинхронном режиме.
- **Docker & Docker Compose**: Для контейнеризации, управления мультиконтейнерным приложением и его безопасного развертывания.

## Архитектура и Безопасность

### Структура Базы Данных

База данных спроектирована по нормализованному принципу для обеспечения гибкости и масштабируемости.

- **`products`**: Центральная таблица, содержащая общую для всех товаров информацию (название, цена, бренд и т.д.).
- **Таблицы спецификаций (`product_doors`, `product_furniture` и т.д.)**: Для каждой категории товаров существует отдельная таблица, которая хранит уникальные для этой категории атрибуты.
- **Справочные таблицы (`categories`, `brands`, `colors` и т.д.)**: Таблицы для хранения повторяющихся данных (стили, материалы, цвета).
- **Таблицы связей (`product_textures`, `door_available_locks`)**: Для реализации отношений "один-ко-многим" и "многие-ко-многим".

### Модель Безопасности

Приложение следует современным практикам безопасности:

1.  **Принцип наименьших привилегий**: Приложение **не использует** аккаунт суперпользователя `postgres` для работы. Вместо этого при инициализации БД создается специальный пользователь `app_user` с ограниченными правами (только `SELECT`, `INSERT`, `UPDATE`, `DELETE` в рамках нужной схемы).
2.  **Изоляция сети**: База данных запускается в изолированной сети Docker и не доступна напрямую извне. Доступ к ней имеет только контейнер с приложением.
3.  **Управление конфигурацией**: Учетные данные и параметры БД не хранятся в коде, а передаются через переменные окружения, что позволяет гибко настраивать приложение для разных окружений (разработка, продакшн).

## Запуск и Администрирование

### Инициализация Базы Данных

При первом запуске Docker Compose выполняет все SQL-скрипты из директории `./deploy` в алфавитном порядке.
- **`00-schema.sql`**: Создает всю структуру таблиц, индексы и триггеры.
- **`01-init-user.sql`**: Создает пользователя `app_user` и выдает ему необходимые права на доступ к созданным таблицам.

### Запуск Проекта

1.  **Убедитесь, что у вас установлен Docker и Docker Compose.**
2.  **Создайте файл `.env`** в корне проекта для переменных окружения (если нужно переопределить стандартные значения):
    ```env
    # Учетные данные для инициализации БД (суперпользователь)
    DB_USER=postgres
    DB_PASSWORD=postgres
    DB_NAME=interior_db

    # Учетные данные для приложения (ограниченный пользователь)
    DB_APP_USER=app_user
    DB_APP_PASSWORD=app_password
    ```
3.  **Запустите приложение** с помощью Docker Compose:
    ```bash
    docker-compose up --build -d
    ```
    Эта команда соберет образы, создаст и запустит контейнеры, а также выполнит скрипты инициализации БД.

4. **Наполнение базы данных (опционально)**:
    Вы можете наполнить базу данных тестовыми данными, выполнив SQL-скрипт `data.sql` внутри контейнера `db`.

    ```powershell
    docker cp data.sql <container_id>:/data.sql; docker exec -u postgres <container_id> psql -d interior_db -f /data.sql
    ```
    Замените `<container_id>` на ID вашего контейнера `db`, который можно узнать командой `docker ps`.

## API Эндпоинты

Интерактивная документация API доступна по адресу `http://localhost:8000/docs` после запуска приложения.

### `GET /products/`

Универсальный эндпоинт для получения списка продуктов по категории с возможностью фильтрации.

- **Параметры**:
  - `category_name` (обязательный, string): Название категории для фильтрации (например, "Двери", "Мебель").
  - `min_price` (опционально, float): Минимальная цена.
  - `max_price` (опционально, float): Максимальная цена.
  - `style` (опционально, string): Название стиля.
  - `brand` (опционально, string): Название бренда.

- **Пример запроса (Двери)**:
  ```bash
  curl -X GET "http://localhost:8000/products/?category_name=Двери&min_price=10000&style=Современный"
  ```

- **Пример запроса (Мебель)**:
  ```bash
  curl -X GET "http://localhost:8000/products/?category_name=Мебель&brand=IKEA"
  ```

- **Пример ответа**:
  ```json
  [
    {
      "product_id": 1,
      "name": "Дубовая дверь 'Классика'",
      "description": "Элегантная дверь из массива дуба.",
      "price": 25000.0,
      "brand_name": "Дверной Мастер",
      "style_name": "Классический",
      "category_name": "Двери",
      "specific_attributes": {
        "product_id": 1,
        "door_type": "Межкомнатная",
        "opening_direction": "Левое",
        "opening_mechanism": "Распашной"
      },
      "textures": [
        {
          "texture_id": 1,
          "name": "Светлый дуб",
          "preview_image_url": "/textures/dub-light.jpg",
          "texture_file_url": "/textures/files/dub-light.uasset",
          "is_default": true
        }
      ]
    }
  ]
  ```

### `POST /filters/`

Сохраняет пользовательский набор фильтров.

- **Параметры**:
  - `user_id` (обязательный, в заголовках или как параметр): ID пользователя.
- **Тело запроса**:
  ```json
  {
    "name": "Мой фильтр для гостиной",
    "filters": {
      "category_name": "Мебель",
      "style": "Лофт",
      "max_price": 50000
    }
  }
  ```

- **Пример запроса**:
  ```bash
  curl -X POST "http://localhost:8000/filters/?user_id=123" -H "Content-Type: application/json" -d '{"name": "Мой фильтр", "filters": {"category_name": "Мебель"}}'
  ```

## Описание API Эндпоинтов

### 1. Получение списка дверей

- **Endpoint**: `GET /doors/`
- **Описание**: Возвращает список дверей с возможностью сложной фильтрации.
- **Query-параметры (все опциональные)**:
    - `room_type: str` - Тип комнаты (например, "Гостиная"). Поиск по частичному совпадению без учета регистра.
    - `min_price: float` - Минимальная цена.
    - `max_price: float` - Максимальная цена.
    - `style: str` - Название стиля (например, "Классический"). Поиск по частичному совпадению.
    - `material: str` - Название материала (например, "дуб"). Поиск по частичному совпадению.
    - `brand: str` - Название бренда. Поиск по частичному совпадению.
- **Пример запроса `curl`**:
  ```bash
  # Найти все двери в классическом стиле дороже 30000
  curl "http://localhost:8000/doors/?style=Классический&min_price=30000"
  ```
- **Пример успешного ответа (200 OK)**:
  ```json
  [
    {
      "product_id": 1,
      "name": "Дверь \"Версаль\"",
      "price": 35000.0,
      "description": "Элегантная дверь из массива дуба в классическом стиле. Идеально для гостиной.",
      "category": "Межкомнатные двери",
      "style": "Классический",
      "brand": null,
      "material": "Массив дуба",
      "room_type": "Гостиная"
    }
  ]
  ```

### 2. Сохранение пользовательского фильтра

- **Endpoint**: `POST /filters/`
- **Описание**: Сохраняет набор фильтров для конкретного пользователя.
- **Query-параметры**:
    - `user_id: int` (обязательный) - ID пользователя, для которого сохраняется фильтр.
- **Тело запроса (Request Body)**:
  - `name: str` - Название для сохраняемого фильтра.
  - `filters: dict` - JSON-объект с параметрами фильтрации.
- **Пример запроса `curl`**:
  ```bash
  curl -X POST "http://localhost:8000/filters/?user_id=1" \
  -H "Content-Type: application/json" \
  -d '{
    "name": "Мои двери для дачи",
    "filters": {
      "style": "Классический",
      "max_price": 40000
    }
  }'
  ```
- **Пример успешного ответа (201 Created)**:
  ```json
  {
    "status": "saved",
    "filter_name": "Мои двери для дачи"
  }
  ```
- **Пример ответа при ошибке (401 Unauthorized)**:
  ```json
  {
    "detail": "User ID is required to save filters"
  }
  ```

## Структура проекта

- `main.py`: Основной файл приложения FastAPI со всей логикой API.
- `docker-compose.yaml`: Файл конфигурации для оркестрации Docker-контейнеров.
- `Dockerfile.dockerfile`: Инструкции по сборке Docker-образа для приложения FastAPI.
- `requirements.txt`: Список Python-зависимостей.
- `00-schema.sql`: SQL-схема для создания структуры базы данных при первом запуске.
- `01-init-user.sql`: SQL-схема распределения прав пользователей.
- `README.md`: Эта документация. 