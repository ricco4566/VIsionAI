# API Каталога Товаров для Интерьера

Этот проект представляет собой FastAPI-приложение для управления каталогом товаров для интерьера. Он использует PostgreSQL в качестве базы данных и Docker для легкого развертывания.

## Ключевые Технологии

- **FastAPI**: Современный, быстрый (высокопроизводительный) веб-фреймворк для создания API.
- **PostgreSQL**: Мощная, объектно-реляционная система управления базами данных.
- **Asyncpg**: Высокопроизводительный драйвер для работы с PostgreSQL в асинхронном режиме.
- **Docker & Docker Compose**: Для контейнеризации и управления мультиконтейнерным приложением.

## Структура Базы Данных

База данных спроектирована по нормализованному принципу для обеспечения гибкости и масштабируемости.

- **`products`**: Центральная таблица, содержащая общую для всех товаров информацию (название, цена, бренд и т.д.).
- **Таблицы спецификаций (`product_doors`, `product_furniture` и т.д.)**: Для каждой категории товаров существует отдельная таблица, которая хранит уникальные для этой категории атрибуты. Это позволяет избежать "раздувания" основной таблицы и хранить данные структурированно.
- **Справочные таблицы (`categories`, `brands`, `colors` и т.д.)**: Таблицы для хранения повторяющихся данных, таких как стили, материалы, цвета. Это уменьшает избыточность и упрощает управление.
- **`product_textures`**: Связывает продукты с доступными для них текстурами (один-ко-многим).

ER-диаграмма доступна в чате.

## Запуск Проекта

1.  **Убедитесь, что у вас установлен Docker и Docker Compose.**
2.  **Создайте файл `.env`** в корне проекта для переменных окружения (если нужно переопределить стандартные значения):
    ```env
    DB_USER=postgres
    DB_PASSWORD=postgres
    DB_NAME=interior_db
    DB_HOST=db
    ```
3.  **Запустите приложение** с помощью Docker Compose:
    ```bash
    docker-compose up --build -d
    ```
    Эта команда соберет образы, создаст и запустит контейнеры для приложения (`app`) и базы данных (`db`). База данных будет автоматически инициализирована с помощью скрипта `deploy/schema.sql`.

4. **Наполнение базы данных (опционально)**:
    Вы можете наполнить базу данных тестовыми данными, выполнив SQL-скрипт `data.sql` внутри контейнера `db`.

    ```powershell
    docker cp data.sql <container_id>:/data.sql; docker exec -u postgres <container_id> psql -d interior_db -f /data.sql
    ```
    Замените `<container_id>` на ID вашего контейнера `db`, который можно узнать командой `docker ps`.

## API Эндпоинты

Интерактивная документация API доступна по адресу `http://localhost:8000/docs` после запуска приложения.

### `GET /products/`

Универсальный эндпоинт для получения списка продуктов по категории с возможностью фильтрации.

- **Параметры**:
  - `category_name` (обязательный, string): Название категории для фильтрации (например, "Двери", "Мебель").
  - `min_price` (опционально, float): Минимальная цена.
  - `max_price` (опционально, float): Максимальная цена.
  - `style` (опционально, string): Название стиля.
  - `brand` (опционально, string): Название бренда.

- **Пример запроса (Двери)**:
  ```bash
  curl -X GET "http://localhost:8000/products/?category_name=Двери&min_price=10000&style=Современный"
  ```

- **Пример запроса (Мебель)**:
  ```bash
  curl -X GET "http://localhost:8000/products/?category_name=Мебель&brand=IKEA"
  ```

- **Пример ответа**:
  ```json
  [
    {
      "product_id": 1,
      "name": "Дубовая дверь 'Классика'",
      "description": "Элегантная дверь из массива дуба.",
      "price": 25000.0,
      "brand_name": "Дверной Мастер",
      "style_name": "Классический",
      "category_name": "Двери",
      "specific_attributes": {
        "product_id": 1,
        "door_type": "Межкомнатная",
        "opening_direction": "Левое",
        "opening_mechanism": "Распашной"
      },
      "textures": [
        {
          "texture_id": 1,
          "name": "Светлый дуб",
          "preview_image_url": "/textures/dub-light.jpg",
          "texture_file_url": "/textures/files/dub-light.uasset",
          "is_default": true
        }
      ]
    }
  ]
  ```

### `POST /filters/`

Сохраняет пользовательский набор фильтров.

- **Параметры**:
  - `user_id` (обязательный, в заголовках или как параметр): ID пользователя.
- **Тело запроса**:
  ```json
  {
    "name": "Мой фильтр для гостиной",
    "filters": {
      "category_name": "Мебель",
      "style": "Лофт",
      "max_price": 50000
    }
  }
  ```

- **Пример запроса**:
  ```bash
  curl -X POST "http://localhost:8000/filters/?user_id=123" -H "Content-Type: application/json" -d '{"name": "Мой фильтр", "filters": {"category_name": "Мебель"}}'
  ```

## Описание API Эндпоинтов

### 1. Получение списка дверей

- **Endpoint**: `GET /doors/`
- **Описание**: Возвращает список дверей с возможностью сложной фильтрации.
- **Query-параметры (все опциональные)**:
    - `room_type: str` - Тип комнаты (например, "Гостиная"). Поиск по частичному совпадению без учета регистра.
    - `min_price: float` - Минимальная цена.
    - `max_price: float` - Максимальная цена.
    - `style: str` - Название стиля (например, "Классический"). Поиск по частичному совпадению.
    - `material: str` - Название материала (например, "дуб"). Поиск по частичному совпадению.
    - `brand: str` - Название бренда. Поиск по частичному совпадению.
- **Пример запроса `curl`**:
  ```bash
  # Найти все двери в классическом стиле дороже 30000
  curl "http://localhost:8000/doors/?style=Классический&min_price=30000"
  ```
- **Пример успешного ответа (200 OK)**:
  ```json
  [
    {
      "product_id": 1,
      "name": "Дверь \"Версаль\"",
      "price": 35000.0,
      "description": "Элегантная дверь из массива дуба в классическом стиле. Идеально для гостиной.",
      "category": "Межкомнатные двери",
      "style": "Классический",
      "brand": null,
      "material": "Массив дуба",
      "room_type": "Гостиная"
    }
  ]
  ```

### 2. Сохранение пользовательского фильтра

- **Endpoint**: `POST /filters/`
- **Описание**: Сохраняет набор фильтров для конкретного пользователя.
- **Query-параметры**:
    - `user_id: int` (обязательный) - ID пользователя, для которого сохраняется фильтр.
- **Тело запроса (Request Body)**:
  - `name: str` - Название для сохраняемого фильтра.
  - `filters: dict` - JSON-объект с параметрами фильтрации.
- **Пример запроса `curl`**:
  ```bash
  curl -X POST "http://localhost:8000/filters/?user_id=1" \
  -H "Content-Type: application/json" \
  -d '{
    "name": "Мои двери для дачи",
    "filters": {
      "style": "Классический",
      "max_price": 40000
    }
  }'
  ```
- **Пример успешного ответа (201 Created)**:
  ```json
  {
    "status": "saved",
    "filter_name": "Мои двери для дачи"
  }
  ```
- **Пример ответа при ошибке (401 Unauthorized)**:
  ```json
  {
    "detail": "User ID is required to save filters"
  }
  ```

## Структура проекта

- `main.py`: Основной файл приложения FastAPI со всей логикой API.
- `docker-compose.yaml`: Файл конфигурации для оркестрации Docker-контейнеров.
- `Dockerfile.dockerfile`: Инструкции по сборке Docker-образа для приложения FastAPI.
- `requirements.txt`: Список Python-зависимостей.
- `schema.sql`: SQL-схема для создания структуры базы данных при первом запуске.
- `README.md`: Эта документация. 